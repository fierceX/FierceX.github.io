<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>使用Gluon和tornado搞一个汪星人种族识别网页 &middot; FierceX</title>
        <meta name="description" content="使用上篇的120种狗分类得到的网络模型，就可以搞一个简单的web网页了。
这里使用了uikit最为UI前端库，tornado最为web和服务器框架。
1. 搞个输出结果的东东 这里只给出这一部分，全部参看上一篇和完整代码
具体作用就是读取图像文件然后跑一遍网络，根据标签文件得到这到底是哪条狗
class Pre(): def __init__(self,nameparams,idx,ctx=0): self.idx = idx if ctx == 0: self.ctx = mx.cpu() if ctx == 1: self.ctx = mx.gpu() self.net = Net(self.ctx,nameparams=nameparams).net self.Timg = transform_test def PreImg(self,img): imgs = self.Timg(img,None) out = nd.softmax(self.net(nd.reshape(imgs[0],(1,3,224,224)).as_in_context(self.ctx),nd.reshape(imgs[1],(1,3,299,299)).as_in_context(self.ctx))).asnumpy() return self.idx[np.where(out == out.max())[1][0]] def PreName(self,Name): img = image.imread(Name) return self.PreImg(img)  2. 编写web 2.1 文件目录框架  static (存放静态文件，包括css和js文件)  css js icon image  templates (存放模板文件，这里就一个主页)  index.">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="generator" content="Hugo 0.28" />
        <meta name="robots" content="index,follow">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta property="og:title" content="使用Gluon和tornado搞一个汪星人种族识别网页">
<meta property="og:description" content="使用上篇的120种狗分类得到的网络模型，就可以搞一个简单的web网页了。
这里使用了uikit最为UI前端库，tornado最为web和服务器框架。
1. 搞个输出结果的东东 这里只给出这一部分，全部参看上一篇和完整代码
具体作用就是读取图像文件然后跑一遍网络，根据标签文件得到这到底是哪条狗
class Pre(): def __init__(self,nameparams,idx,ctx=0): self.idx = idx if ctx == 0: self.ctx = mx.cpu() if ctx == 1: self.ctx = mx.gpu() self.net = Net(self.ctx,nameparams=nameparams).net self.Timg = transform_test def PreImg(self,img): imgs = self.Timg(img,None) out = nd.softmax(self.net(nd.reshape(imgs[0],(1,3,224,224)).as_in_context(self.ctx),nd.reshape(imgs[1],(1,3,299,299)).as_in_context(self.ctx))).asnumpy() return self.idx[np.where(out == out.max())[1][0]] def PreName(self,Name): img = image.imread(Name) return self.PreImg(img)  2. 编写web 2.1 文件目录框架  static (存放静态文件，包括css和js文件)  css js icon image  templates (存放模板文件，这里就一个主页)  index.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://FierceX.github.io/post/gluon_web/">
        <link rel="stylesheet" href="https://FierceX.github.io/dist/styles.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,400,600,700,300&subset=latin,cyrillic-ext,latin-ext,cyrillic">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        
        
    </head>
    <body>
        

        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                        
                            <h1 class="site-title">
                                <a title="FierceX" href="https://FierceX.github.io/">FierceX</a>
                            </h1>
                        
                        <a class="button-square" href="https://FierceX.github.io/index.xml"><i class="fa fa-rss"></i></a>
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Github" title="Github" href="https://github.com/fiercex">
                                <i class="fa fa-github-alt"></i>
                            </a>
                        
                        
                        
                        
                        
                            <a class="button-square button-social hint--top" data-hint="Email" title="Email" href="mailto:mailto:FierceX@outlook.com">
                                <i class="fa fa-envelope"></i>
                            </a>
                        
                    </div>

                    <ul class="site-nav">
                        
    <li class="site-nav-item">
        <a title="Blog" href="/">Blog</a>
    </li>

    <li class="site-nav-item">
        <a title="About" href="/about/">About</a>
    </li>

                    </ul>
                </div>
            </header>

            <div id="container">


<div class="container">
    <article class="post-container" itemscope="" itemtype="http://schema.org/BlogPosting">
        <header class="post-header">
    <h1 class="post-title" itemprop="name headline">使用Gluon和tornado搞一个汪星人种族识别网页</h1>
    
    <p class="post-date">
        <span>Published <time datetime="2017-12-15" itemprop="datePublished">Fri, Dec 15, 2017</time></span>
        <span>by</span>
        <span itemscope="" itemprop="author" itemtype="https://schema.org/Person">
            <span itemprop="name">
                <a href="https://FierceX.github.io" itemprop="url" rel="author">FierceX</a>
            </span>
        </span>
    </p>
</header>

        <div class="post-content clearfix" itemprop="articleBody">
    

    

<p>使用上篇的120种狗分类得到的网络模型，就可以搞一个简单的web网页了。<br />
这里使用了<code>uikit</code>最为UI前端库，<code>tornado</code>最为web和服务器框架。</p>

<h2 id="1-搞个输出结果的东东">1. 搞个输出结果的东东</h2>

<p>这里只给出这一部分，全部参看上一篇和完整代码<br />
具体作用就是读取图像文件然后跑一遍网络，根据标签文件得到这到底是哪条狗</p>

<pre><code class="language-python">class Pre():
    def __init__(self,nameparams,idx,ctx=0):
        self.idx = idx
        if ctx == 0:
            self.ctx = mx.cpu()
        if ctx == 1:
            self.ctx = mx.gpu()
        self.net = Net(self.ctx,nameparams=nameparams).net
        self.Timg = transform_test
    def PreImg(self,img):
        imgs = self.Timg(img,None)
        out = nd.softmax(self.net(nd.reshape(imgs[0],(1,3,224,224)).as_in_context(self.ctx),nd.reshape(imgs[1],(1,3,299,299)).as_in_context(self.ctx))).asnumpy()
        return self.idx[np.where(out == out.max())[1][0]]
    def PreName(self,Name):
        img = image.imread(Name)
        return self.PreImg(img)
</code></pre>

<h2 id="2-编写web">2. 编写web</h2>

<h3 id="2-1-文件目录框架">2.1 文件目录框架</h3>

<ul>
<li>static (存放静态文件，包括css和js文件)

<ul>
<li>css</li>
<li>js</li>
<li>icon</li>
<li>image</li>
</ul></li>
<li>templates (存放模板文件，这里就一个主页)

<ul>
<li>index.html</li>
</ul></li>
<li>app.py (web主代码)</li>
<li>model.py  (网络模型代码)<br /></li>
</ul>

<p>把css和js代码分别放在css和js文件夹下，把模板主页放在模板文件夹下。另外我还放了三个图标放在了icon目录下。</p>

<h3 id="2-2-编写web主代码">2.2 编写web主代码</h3>

<p>这是使用了tornado这个框架，因为我刚开始准备学web框架，看这个眼熟。<br />
导入各种包</p>

<pre><code class="language-python">import os.path
import tornado.httpserver
import tornado.ioloop
import tornado.options
import tornado.web
import os
import pickle
from tornado.options import define, options
from model import Pre #这个就是上面的那个类
</code></pre>

<p>首先搞好预测代码</p>

<pre><code class="language-python">netparams = 'train.params'
ids_synsets_name = 'ids_synsets'
f = open(ids_synsets_name,'rb')
ids_synsets = pickle.load(f)
f.close()
PP = Pre(netparams,ids_synsets[1],1)
</code></pre>

<p>因为上传的图片是暂存在静态目录里的，所以，每次上传的时候，我就把之前的所有图片都删了。免得占空间</p>

<pre><code class="language-python">def RemoveFile(dirhname):
    for root, dirs, files in os.walk(dirhname):
        for name in files:
            os.remove(os.path.join(root, name))
</code></pre>

<p>首页请求代码</p>

<pre><code class="language-python">class IndexHandler(tornado.web.RequestHandler):
    def get(self):
        self.render('index.html',imagename=&quot;&quot;,classname=&quot;&quot;)
</code></pre>

<p>然后就是上传网页的处理函数</p>

<pre><code class="language-python">class Update_Image(tornado.web.RequestHandler):
    def post(self):
        RemoveFile(&quot;./static/image/&quot;)
        img = self.request.files['file'][0]
        f = open(&quot;./static/image/&quot;+img['filename'],'wb')
        f.write(img['body'])
        f.close()
        classname = PP.PreName(&quot;./static/image/&quot;+img['filename']).lower()
        self.render('index.html',imagename=&quot;./static/image/&quot;+img['filename'],classname = classname)
</code></pre>

<p>然后就是启动代码了</p>

<pre><code class="language-python">define(&quot;port&quot;, default=8000, help=&quot;run on the given port&quot;, type=int)
if __name__ == '__main__':
    tornado.options.parse_command_line()
    app = tornado.web.Application(
        handlers=[(r'/', IndexHandler), (r'/Updata_Image', Update_Image)],
        template_path=os.path.join(os.path.dirname(__file__), &quot;./templates&quot;),
        static_path=os.path.join(os.path.dirname(__file__),'./static'),
        debug=True
    )
    http_server = tornado.httpserver.HTTPServer(app)
    http_server.listen(options.port)
    tornado.ioloop.IOLoop.instance().start()
</code></pre>

<h2 id="3-写网页">3. 写网页</h2>

<p>这块也是现学现写，ui库用的是<code>uikit</code></p>

<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;

&lt;head&gt;
    &lt;title&gt;Index&lt;/title&gt;
    &lt;title&gt;&lt;/title&gt;
    &lt;link rel=&quot;stylesheet&quot; href=&quot;{{ static_url(&quot;css/uikit.min.css &quot;)}}&quot; /&gt;
    &lt;script src=&quot;{{ static_url(&quot;js/jquery.js &quot;)}}&quot;&gt;&lt;/script&gt;
    &lt;script src=&quot;{{ static_url(&quot;js/uikit.min.js &quot;)}}&quot;&gt;&lt;/script&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div uk-grid class=&quot;uk-flex uk-flex-column&quot;&gt;
        &lt;div class=&quot; uk-background-primary uk-position-top&quot; uk-grid&gt;

            &lt;div class=&quot;uk-card uk-card-body uk-card-primary uk-width-1-1 &quot;&gt;
                &lt;h3 class=&quot;uk-card-title uk-position-center&quot;&gt;汪星人种族鉴定&lt;/h3&gt;

            &lt;/div&gt;

        &lt;/div&gt;


        &lt;div uk-grid&gt;
            &lt;div class=&quot;uk-margin-auto uk-margin-large-top &quot;&gt;
                &lt;div class=&quot;uk-card uk-card-default uk-card-hover  uk-card-body&quot;&gt;
                    &lt;h3 class=&quot;uk-card-title&quot;&gt;{{classname}}&lt;/h3&gt;
                    &lt;img src=&quot;{{imagename}}&quot; /&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;


        &lt;div uk-grid&gt;
            &lt;div class=&quot;uk-margin-auto uk-margin-xlarge-bottom  &quot;&gt;
                &lt;div class=&quot;uk-card uk-card-default  uk-card-hover uk-card-body&quot;&gt;
                    &lt;form method='post' action='/Updata_Image' enctype=multipart/form-data&gt;
                        &lt;div class=&quot;uk-margin&quot; uk-margin&gt;
                            &lt;div uk-form-custom=&quot;target: true&quot;&gt;
                                &lt;input type=&quot;file&quot; name=file&gt;
                                &lt;input class=&quot;uk-input uk-form-width-medium&quot; type=&quot;text&quot; placeholder=&quot;Select file&quot; disabled&gt;
                            &lt;/div&gt;
                            &lt;button class=&quot;uk-button uk-button-default&quot;&gt;Submit&lt;/button&gt;
                        &lt;/div&gt;
                    &lt;/form&gt;
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;


        &lt;div class=&quot; uk-background-secondary uk-position-bottom uk-position-fixed&quot; uk-grid&gt;
            &lt;div class=&quot;uk-margin-auto uk-grid-small uk-flex uk-flex-row&quot; uk-grid&gt;
                &lt;div class=&quot;uk-card uk-card-body uk-card-secondary&quot; title=&quot;这是一个基于Python的Web框架和服务器&quot; uk-tooltip&gt;
                    &lt;a href=&quot;http://www.tornadoweb.org&quot; target=&quot;_blank&quot;&gt;
                        &lt;img width=&quot;100&quot; src=&quot;{{static_url(&quot;icon/tornado.png &quot;)}}&quot; /&gt;
                    &lt;/a&gt;
                &lt;/div&gt;
                &lt;div class=&quot;uk-card uk-card-body uk-card-secondary&quot; title=&quot;这是一个深度学习框架Mxnet的Python前端接口&quot; uk-tooltip&gt;
                    &lt;a href=&quot;http://zh.gluon.ai/&quot; target=&quot;_blank&quot;&gt;
                        &lt;img width=&quot;150&quot; src=&quot;{{static_url(&quot;icon/gluon.png &quot;)}}&quot; /&gt;
                    &lt;/a&gt;

                &lt;/div&gt;
                &lt;div class=&quot;uk-card uk-card-body uk-card-secondary &quot; title=&quot;这是一个Web前端框架&quot; uk-tooltip&gt;
                    &lt;a href=&quot;https://getuikit.com/&quot; target=&quot;_blank&quot;&gt;
                        &lt;img width=&quot;90&quot; src=&quot;{{static_url(&quot;icon/uikit.svg &quot;)}}&quot; /&gt;
                    &lt;/a&gt;

                &lt;/div&gt;
            &lt;/div&gt;

        &lt;/div&gt;

    &lt;/div&gt;

&lt;/body&gt;

&lt;/html&gt;
</code></pre>

<h2 id="4-运行看看效果">4. 运行看看效果</h2>

<p>运行<code>app.py</code>文件，看看效果</p>

<p><img src="/img/cluon_web.jpg" alt="jpg" /></p>

<p>完整代码: <a href="https://github.com/fierceX/Dog-Breed-Identification-Gluon">https://github.com/fierceX/Dog-Breed-Identification-Gluon</a></p>

</div>

        <footer class="post-footer clearfix">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.css"> 
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/katex.min.js"></script> 
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.6.0/contrib/auto-render.min.js"></script> 
    <div class="share">
        

        

        
        
    </div>
</footer>

        
    </article>
</div>

            </div>
        </div>

        <footer class="footer">
            <div class="container">
                <div class="site-title-wrapper">
                    <h1 class="site-title">
                        <a title="FierceX" href="https://FierceX.github.io/">FierceX</a>
                    </h1>
                    <a class="button-square button-jump-top js-jump-top" href="#">
                        <i class="fa fa-angle-up"></i>
                    </a>
                </div>

                <p class="footer-copyright">
                    <span> &copy; 2018 | 夏鲁豫 </span>
                </p>
                <p class="footer-copyright">
                    <span>Powered by <a href="https://gohugo.io/">Hugo</a> And <a href="https://github.com/roryg/ghostwriter">Ghostwriter</a></span>
                </p>
                
            </div>
        </footer>

        <script src="https://FierceX.github.io/js/jquery-1.11.3.min.js"></script>
        <script src="https://FierceX.github.io/js/jquery.fitvids.js"></script>
        
        
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        
        <script src="https://FierceX.github.io/js/scripts.js"></script>
    </body>
</html>

